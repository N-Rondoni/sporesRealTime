# author: Alexandra Nava
# date: 2025-09-24
# description: Short description of the file

import pandas as pd
import numpy as np

def smooth_trace(trace: np.array, alpha: float = 0.3) -> np.array: 
  '''
  :trace: a 1D numpy array with values of the trace intensity over time 
  :return: a smoothed version of the trace 
  '''
  smoothed_trace = np.zeros_like(trace)
  smoothed_trace[0] = trace[0]
  for t in range(1, len(trace)):
    smoothed_trace[t] = alpha * trace[t] + (1 - alpha) * smoothed_trace[t-1]
  
  return smoothed_trace

def check_if_germination_occurs_now(phase_trace: np.array, drop_threshold: float = 0.1) -> int:
  baseline = np.mean(phase_trace[:5])  # average phase value of first 5 frames
  threshold = baseline * (1 - drop_threshold)    # drop_threshold% drop

  if phase_trace[-1] < threshold:
    germination_occurs = 1
  else:
    germination_occurs = 0

  return germination_occurs

def plot_and_save_phase_trace(phase_traces: pd.DataFrame, save_path: str) -> None:
  sns.lineplot(x = 'timepoint', y = 'mean_intensity', hue = 'label', data = phase_traces)
  df_during_germination = phase_traces[phase_traces['germination_status'] == 1]
  df_during_dormant = phase_traces[phase_traces['germination_status'] == 0]
  sns.scatterplot(x = 'timepoint', y = 'mean_intensity', color = "black", data = df_during_germination, marker='o', s=50, legend=False)
  sns.scatterplot(x = 'timepoint', y = 'mean_intensity', color = "lightgrey", data = df_during_dormant, marker='o', s=50, legend=False)
  plt.savefig(save_path)
  plt.close()

def write_germination_status(property_data_csv, t, plot_and_save_phase_trace = False) -> pd.DataFrame:
  '''
  :property_data_csv: path to the csv file with spore properties over all timepoints
  :t: current timepoint integer to add germination status for
  :return: None, but updates the csv file "germination_status" at time t with 0 or 1 for each spore
  '''
  print(f"calculating germination statuses...")
  spore_id_column = "label"
  phase_trace_column = "mean_intensity"
  germination_status_column = "germination_status"
  time_column = "timepoint"

  population_data = pd.read_csv(property_data_csv)
  if germination_status_column not in population_data.columns:
        population_data[germination_status_column] = None
  
  # write timepoint column of fill with current timepoint
  if time_column not in population_data.columns:
    print("made it to check 3:55 pm 11/10")
    population_data[time_column] = t
  else:
    population_data[time_column] = population_data[time_column].fillna(t)
    print("made it to else, 3:55pm 11/10")

  for spore_id in population_data[spore_id_column].unique():
    spore_data: pd.DataFrame = population_data[population_data[spore_id_column] == spore_id]
    germination_status_over_time = spore_data[germination_status_column]
    if 1 in germination_status_over_time.values:
      germination_status_t = 1
    if 1 not in germination_status_over_time.values: 
      phase_trace: np.array = spore_data[phase_trace_column].values
      smoothed_phase_trace: np.array = smooth_trace(phase_trace)
      germination_status_t = check_if_germination_occurs_now(smoothed_phase_trace)
      population_data.loc[
          (population_data[spore_id_column] == spore_id) &
          (population_data[time_column] == t),
          germination_status_column
      ] = germination_status_t

  return population_data
if __name__ == "__main__":


  output_dir = '/Users/alexandra/Desktop/Spores/Device_Scripts/Test_Output/' #directory for masks, images, and data 
  spore_data_output_path = output_dir + "PhC_spore_data.csv" #where to write spore data including physiological features and germination statuses for all timepoints 
  population_data = write_germination_status(spore_data_output_path, 0)
  print(population_data)
